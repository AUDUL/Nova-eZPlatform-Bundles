{% extends '@EzPublishCore/content_fields.html.twig' %}

{# This field accepts the following parameters:
 #   - alias (image variation name). Defaults to "original" (e.g. image originally uploaded)
 #   - parameters.width. Allows forcing width of the image in the HTML
 #   - parameters.height. Allows forcing height of the image in the HTML
 #   - parameters.class. Allows setting CSS custom class name for the image
 #}
{% block enhancedimage_field %}
    {% spaceless %}
        {% if not ez_is_field_empty( content, field ) %}
            {% set imageAlias = ez_focused_image_alias( field, versionInfo, parameters.alias|default( 'original' ) ) %}
            {% set alternativeAliasList = parameters.alternativeAlias|default( [] ) %}

            {% if imageAlias %}
                {% set attr = attr|merge({
                    'class': (attr.class|default('') ~ ' enhancedimage--wrapper')|trim,
                }) %}
            {% endif %}
            <picture {{ block( 'field_attributes' ) }}>
                {% set attrs = {
                    class: parameters.class|default('') ~ ' enhancedimage--img',
                } %}

                {% if imageAlias %}
                    {% set attrs = attrs|merge({
                        'data-focus-x': imageAlias.focusPoint is defined ? imageAlias.focusPoint.posX : 0,
                        'data-focus-y': imageAlias.focusPoint is defined ? imageAlias.focusPoint.posY : 0,
                        'data-image-h': parameters.height is defined ? parameters.height : (imageAlias ? imageAlias.height : ''),
                        'data-image-w': parameters.width is defined ? parameters.width : (imageAlias ? imageAlias.width : ''),
                    }) %}
                {% endif %}
                {% for alternativeAlias in alternativeAliasList %}
                    {% set alternativeImageAlias = ez_focused_image_alias( field, versionInfo, alternativeAlias.alias ) %}

                    {% if alternativeImageAlias %}
                        <source
                            srcset="{{ asset( alternativeImageAlias.uri ) }}"
                            media="{{ alternativeAlias.media }}"
                            data-name="{{ alternativeAlias.alias }}"
                            data-focus-x="{{ alternativeImageAlias.focusPoint is defined ? alternativeImageAlias.focusPoint.posX : 0 }}"
                            data-focus-y="{{ alternativeImageAlias.focusPoint is defined ? alternativeImageAlias.focusPoint.posY : 0 }}"
                            data-image-h="{{ alternativeImageAlias.height }}"
                            data-image-w="{{ alternativeImageAlias.width }}"
                        />
                    {% endif %}
                {% endfor %}

                <img srcset="{{ imageAlias ? asset( imageAlias.uri ) : "//:0" }}" alt="{{ parameters.alternativeText|default(field.value.alternativeText) }}" {% for attrname, attrvalue in attrs if attrvalue is not empty %}{{ attrname }}="{{ attrvalue }}" {% endfor %}/>
            </picture>
        {% endif %}
    {% endspaceless %}
{% endblock %}
